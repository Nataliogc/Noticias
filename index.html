<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Noticias Â· Hoteles de Calidad en Ciudad Real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- ======= CABECERA PRINCIPAL ======= -->
  <header class="topbar">
    <div class="topbar-left">
      <p class="topbar-eyebrow">Hoteles de Calidad en Ciudad Real</p>
      <h1 class="topbar-title">Noticias</h1>
      <p class="topbar-subtitle">Sercotel Guadiana Â· Cumbria Spa&amp;Hotel</p>
      <div class="topbar-progress"></div>
    </div>

    <div class="topbar-right">
      <div class="logo-pill">
        <img src="img/logo-guadiana.svg" alt="Hotel Guadiana" class="hotel-logo">
      </div>
      <div class="logo-pill">
        <img src="img/logo-cumbria.svg" alt="Cumbria Spa&Hotel" class="hotel-logo">
      </div>
    </div>
  </header>

  <!-- ======= BARRA BUSCADOR PRINCIPAL ======= -->
  <section class="search-toolbar">
    <input
      id="search-main"
      class="search-main"
      type="search"
      placeholder="Buscar noticias, lugares o etiquetas..."
    />

    <div class="search-toolbar-right">
      <label class="sr-only" for="filter-year">Filtrar por aÃ±o</label>
      <select id="filter-year" class="pill-select">
        <option value="">Todos los aÃ±os</option>
      </select>

      <label class="sr-only" for="filter-tag">Filtrar por etiqueta</label>
      <select id="filter-tag" class="pill-select">
        <option value="">Todas las etiquetas</option>
      </select>

      <span id="results-count" class="results-count" aria-live="polite"></span>
    </div>
  </section>

  <!-- ======= CONTENIDO ======= -->
  <main id="app" class="page-main">
    <section class="loading-state">
      Cargando noticiasâ€¦
    </section>
  </main>

  <footer class="page-footer">
    Hoteles de Calidad en Ciudad Real Â· Sercotel Guadiana Â· Cumbria Spa&amp;Hotel Â· Uso interno
  </footer>

  <!-- Datos generados por PowerShell -->
  <script src="data/posts.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const app = document.getElementById("app");
      const postsRaw = Array.isArray(window.POSTS_DATA) ? window.POSTS_DATA.slice() : [];

      if (!postsRaw.length) {
        app.innerHTML = `
          <section class="loading-state">
            <h2>Ãšltimas noticias</h2>
            <p>No hay noticias publicadas todavÃ­a.</p>
          </section>`;
        return;
      }

      // Ordenar por fecha (descendente)
      postsRaw.sort((a, b) => new Date(b.date) - new Date(a.date));

      // ðŸ‘‡ AQUÃ SE ELIGEN LAS DESTACADAS
      const heroPosts  = postsRaw.slice(0, 3);  // 3 Ãºltimas noticias
      const otherPosts = postsRaw.slice(3);     // el resto para el grid

      const years = Array.from(new Set(
        postsRaw
          .map((p) => p.date)
          .filter(Boolean)
          .map((iso) => new Date(iso).getFullYear())
      ))
        .filter((year) => !Number.isNaN(year))
        .sort((a, b) => b - a);

      const tags = Array.from(new Set(
        postsRaw
          .flatMap((p) => Array.isArray(p.tags) ? p.tags : [])
          .filter(Boolean)
      ))
        .sort((a, b) => a.localeCompare(b, "es"));

      app.innerHTML = renderLayout(heroPosts, otherPosts);

      setupHeroSlider();
      setupFilters({ years, tags });
    });


    function renderLayout(heroPosts, otherPosts) {
      let heroHtml = "";

      // === Carrusel de las Ãºltimas noticias ===
      if (heroPosts.length) {
        heroHtml += `
          <section class="hero">
            <div class="hero-slides">
        `;

        heroPosts.forEach((post, index) => {
          const activeClass = index === 0 ? " hero-slide--active" : "";
          heroHtml += `
            <article class="hero-slide${activeClass}" data-index="${index}">
              <div class="hero-slide-left">
                ${
                  post.image
                    ? `<img src="${post.image}" alt="${escapeHtml(post.title || "")}" class="hero-image">`
                    : `<h2 class="hero-slide-title">${escapeHtml(post.title || "")}</h2>`
                }
              </div>
              <div class="hero-slide-right">
                <p class="hero-badge">DESTACADO</p>
                <h3 class="hero-headline">${escapeHtml(post.title || "")}</h3>
                <p class="hero-meta">
                  <span class="hero-date">${formatDate(post.date)}</span>
                  ${
                    post.hotel
                      ? `<span class="hero-hotel">${escapeHtml(post.hotel)}</span>`
                      : ""
                  }
                </p>
                <p class="hero-excerpt">${escapeHtml(post.excerpt || "")}</p>
                <a class="hero-button" href="${post.url || ('posts/' + post.slug)}">Leer completa â†—</a>

                <button class="hero-next-btn" type="button" aria-label="Siguiente noticia">
                  &#x25B6;
                </button>
              </div>
            </article>
          `;
        });

        heroHtml += `
            </div>
            <div class="hero-dots">
        `;

        heroPosts.forEach((_, index) => {
          const activeClass = index === 0 ? " hero-dot--active" : "";
          heroHtml += `
            <button class="hero-dot${activeClass}" data-index="${index}"
                    aria-label="Ver noticia ${index + 1}"></button>
          `;
        });

        heroHtml += `
            </div>
          </section>
        `;
      }

      // === Rejilla 2Ã—N con el resto de noticias ===
      let gridHtml = `
        <section class="news-grid-section">
          <h2 class="section-title">Todas las noticias</h2>
          <div class="news-grid">
      `;

      otherPosts.forEach((post) => {
        const tagList = Array.isArray(post.tags) ? post.tags : [];
        const searchText = (
          (post.title || "") + " " +
          (post.excerpt || "") + " " +
          tagList.join(" ") + " " +
          (post.hotel || "")
        ).toLowerCase();

        const tags = tagList.join("|");
        const year = post.date ? new Date(post.date).getFullYear() : "";

        gridHtml += `
          <article
            class="news-card"
            data-search="${escapeAttr(searchText)}"
            data-year="${escapeAttr(year)}"
            data-tags="${escapeAttr(tags)}"
          >
            ${
              post.image
                ? `<a class="news-card-thumb" href="${post.url || ('posts/' + post.slug)}">

                     <img src="${post.image}" alt="${escapeHtml(post.title || "")}">
                   </a>`
                : ""
            }
            <div class="news-card-body">
              <header class="news-card-header">
                <p class="news-card-date">${formatDate(post.date)}</p>
                ${
                  post.hotel
                    ? `<span class="news-card-hotel">${escapeHtml(post.hotel)}</span>`
                    : ""
                }
              </header>
              <h3 class="news-card-title">
                <a href="${post.url || ('posts/' + post.slug)}">${escapeHtml(post.title || "")}</a>

              </h3>
              <p class="news-card-excerpt">${escapeHtml(post.excerpt || "")}</p>
              <a class="news-card-link" href="${post.url || ('posts/' + post.slug)}">Leer mÃ¡s</a>

            </div>
          </article>
        `;
      });

      gridHtml += `
          </div>
        </section>
      `;

      return heroHtml + gridHtml;
    }

    function setupHeroSlider() {
      const slides = Array.from(document.querySelectorAll(".hero-slide"));
      const dots = Array.from(document.querySelectorAll(".hero-dot"));
      const nextButtons = Array.from(document.querySelectorAll(".hero-next-btn"));
      if (!slides.length) return;

      let current = 0;

      const goTo = (index) => {
        current = (index + slides.length) % slides.length;
        slides.forEach((s, i) => s.classList.toggle("hero-slide--active", i === current));
        dots.forEach((d, i) => d.classList.toggle("hero-dot--active", i === current));
      };

      dots.forEach(dot => {
        dot.addEventListener("click", () => {
          const idx = parseInt(dot.dataset.index, 10) || 0;
          goTo(idx);
        });
      });

      nextButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          goTo(current + 1);
        });
      });

      setInterval(() => goTo(current + 1), 8000);
    }

    function setupFilters({ years, tags }) {
      const input = document.getElementById("search-main");
      const yearSelect = document.getElementById("filter-year");
      const tagSelect = document.getElementById("filter-tag");
      const resultBadge = document.getElementById("results-count");
      const cards = Array.from(document.querySelectorAll(".news-card"));

      if (!cards.length) return;

      populateSelect(yearSelect, "Todos los aÃ±os", years.map((year) => ({
        value: String(year),
        label: String(year),
      })));

      populateSelect(tagSelect, "Todas las etiquetas", tags.map((tag) => ({
        value: tag,
        label: tag,
      })));

      const applyFilters = () => {
        const query = (input?.value || "").trim().toLowerCase();
        const year = yearSelect?.value || "";
        const tag = tagSelect?.value || "";
        let visibleCount = 0;

        cards.forEach((card) => {
          const haystack = (card.getAttribute("data-search") || "").toLowerCase();
          const cardYear = card.getAttribute("data-year") || "";
          const cardTags = (card.getAttribute("data-tags") || "")
            .split("|")
            .filter(Boolean);

          const matchesSearch = !query || haystack.includes(query);
          const matchesYear = !year || cardYear === year;
          const matchesTag = !tag || cardTags.includes(tag);

          const visible = matchesSearch && matchesYear && matchesTag;
          card.style.display = visible ? "" : "none";
          if (visible) visibleCount += 1;
        });

        if (resultBadge) {
          const total = cards.length;
          const label = visibleCount === total
            ? `${visibleCount} noticias`
            : `${visibleCount} resultado${visibleCount === 1 ? "" : "s"}`;
          resultBadge.textContent = label;
        }
      };

      [input, yearSelect, tagSelect].forEach((el) => {
        el?.addEventListener("input", applyFilters);
        el?.addEventListener("change", applyFilters);
      });

      applyFilters();

      document.addEventListener("keydown", (ev) => {
        if ((ev.ctrlKey || ev.metaKey) && ev.key === "/") {
          ev.preventDefault();
          input?.focus();
        }
      });
    }

    function populateSelect(selectEl, defaultLabel, options) {
      if (!selectEl) return;
      selectEl.innerHTML = `<option value="">${escapeHtml(defaultLabel)}</option>` +
        options.map((opt) => `<option value="${escapeAttr(opt.value)}">${escapeHtml(opt.label)}</option>`).join("");
    }

    function formatDate(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      const meses = [
        "enero","febrero","marzo","abril","mayo","junio",
        "julio","agosto","septiembre","octubre","noviembre","diciembre"
      ];
      return `${d.getDate()} de ${meses[d.getMonth()]} de ${d.getFullYear()}`;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function escapeAttr(str) {
      return escapeHtml(str).replace(/'/g, "&#39;");
    }
  </script>
</body>
</html>
